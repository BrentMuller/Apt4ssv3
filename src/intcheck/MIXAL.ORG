*
      SUBROUTINE MIXAL(NPATCH,ISIZE,GEO,PSIDE,PTHICK,TUL,
     1      TOOLCE,TA,U,V,DUMIN,DVMIN,UPEN,VPEN,PPOINT,TPOINT,
     1      PNORM,PENMAX,IPEN,IFLAG,IEDGE,NITERA)
C
C     PURPOSE: INTERFERENCE SEARCH USING MIXED ALGORITHMS
C
C     METHOD:
C
C     FOR INITIAL ESTIMATE U, V ON PATCH NPATCH
C     EVALUATES SURFACE POINT R, DERIVATIVES, AND NORMAL AT U,V
C     CALCULATES POINT T ON TOOL WITH SAME NORMAL
C     CALCULATES ASSOCIATED POINT P ON TOOL, AND TOOL NORMAL PN AT P
C     ESTIMATES DU,DV TO GIVE A BETTER ESTIMATE OF PENETRATION POINT
C     USING VALUES COMPUTED BY BOTH ALGO1 (DU1,DV1) AND ALGO2 (DU2,DV2)
C     WHERE POSSIBLE OTHERWISE RESULTS OF EITHER ALGO1 OR ALGO2 ARE USED
C
C          DU1*DU2             DV1*DV2
C     DU = -------        DV = -------
C          DU1+DU2             DV1+DV2
C
C     ARGUMENTS:
C         ISIZE  - DIMENSION OF GEO
C         PSIDE  - TOOL SIDE OF SURFACE
C         PTHICK - THICK ALLOWANCE REQUIRED
C         TUL    - TOOL GEOMETRY
C
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
C
      DIMENSION GEO(ISIZE)
      DIMENSION TOOLCE(3),TA(3),TUL(7)
      DIMENSION R(3),RU(3),RV(3),RUU(3),RUV(3),RVV(3)
      DIMENSION RN(3)
C
C     LOCAL VARIABLES :
C
      DIMENSION P(3),T(3)
C.... TOOL NORMAL AT P
      DIMENSION PN(3)
C.... WORKSPACE
      DIMENSION V1(3),V2(3),V3(3),V4(3)
      DIMENSION UVSTEP(3)
C
      LOGICAL LBASE,IOK
C
C.... STORAGE FOR DATA FROM LAST FOUR ITERATIONS IF CONVERGENCE
C     NOT ACHIEVED BY NITLIM
C
      DIMENSION SP(3,4),TP(3,4),TN(3,4),UP(4),VP(4),PEN(4)
      DIMENSION JPEN(4),IEDG(4)
C
C     RETURNS:-
C.... MAXIMUM PENETRATION FOUND, FOR UPEN, VPEN
      DIMENSION PPOINT(3)
C     MAY NOT BE FINAL POINT IN ITERATION, BUT IS FOR TRUE (EVALUATED, N
C     EXTRAPOLATED) SURFACE POINT
C.... CORRESPONDING TOOL POINT
      DIMENSION TPOINT(3)
C.... COMMON NORMAL AT PPOINT, TPOINT
      DIMENSION PNORM(3)
C
C     PENMAX      PENETRATION (+VE FOR HIT)
C
C     IFLAG = -1  NO CONVERGENCE
C              0  CONVERGENCE
C
C     IPEN  =  0  CONVERGENCE ON BOTTOM FLAT OF CRC
C              1  CONVERGENCE ON SPHERE FOR BE CUTTER, ON CR FOR CRC
C              2  CONVERGENCE ON SHANK
C
C     IEDGE =  0  LAST DU, DV NOT LIMITED
C              1  LAST DU,DV LIMITED
C
C
      INCLUDE (IBUGG)
C
      CHARACTER MSG*120
C
      PARAMETER (ETA6=1D-6,ETA8=1D-8,NITLIM=20)
      UCON=1
      VCON=1
      IALGO=0
      USTART=U
      VSTART=V
C
      IFLAG=0
C.... 1ST AND 2ND DERIVATIVES FROM EVALUATOR
      MODE=2
C.... ITERATION COUNT
      NITERA=0
      IEXT=0
      DU=0
      DV=0
      PENMAX=-1E6
C.... LOOP START
10    CONTINUE
      NITERA=NITERA+1
C
      IOLD=IALGO
      PREVDU=DU
      PREVDV=DV
      IALGO=0
      IOK=.TRUE.
C
      CALL EVALSS(NPATCH,U,V,ISIZE,GEO,MODE,
     1      R,RU,RV,RUU,RUV,RVV,RN,NORMOK)
C
      CALL PENCUT(R,RN,TOOLCE,TA,TUL,PSIDE,PTHICK,
     1      P,PN,PENMAX,IPEN)
C
C.... CALCULATE POINT T ON TOOL CORRESPONDING TO SURFACE NORMAL RN
C
      CALL CALCT(TUL,TOOLCE,TA,R,RN,PSIDE,T,LBASE)
      IF (LBASE) THEN
C.... T ON BASE FLAT OF TOOL - FORCE ALGORITHM 2 WHERE POSSIBLE
        IALGO=2
      ENDIF
C
C.... ESTIMATE DU AND DV USING ALGORITHM 1
C
      CALL ALGO1(T,R,RN,RU,RV,DU1,DV1)
C
C.... ESTIMATE DU AND DV USING ALGORITHM 2
C
      CALL ALGO2(PN,RU,RV,RUU,RUV,RVV,DU2,DV2,IOK)
      IF (.NOT.IOK) THEN
C.... UNABLE TO COMPUTE DU,DV USING ALGORITHM 2, FORCE USE OF DU1,DV1
C
        IALGO=1
      ENDIF
C
C.... SELECT DU,DV
C
      IF (IALGO.EQ.1) THEN
        DU=DU1
        DV=DV1
      ELSE IF (IALGO.EQ.2) THEN
        DU=DU2
        DV=DV2
      ELSE
C.... MIX ALGORITHMS
        IF ( (ABS(DU1+DU2).LE.ETA6).OR.(ABS(DU2).LE.ETA6) ) THEN
          DU=DU1
        ELSE IF (ABS(DU1).LE.ETA6) THEN
          DU=DU2
        ELSE
          DU=(DU1*DU2)/(DU1+DU2)
        ENDIF
        IF ( (ABS(DV1+DV2).LE.ETA6).OR.(ABS(DV2).LE.ETA6) ) THEN
          DV=DV1
        ELSE IF (ABS(DV1).LE.ETA6) THEN
          DV=DV2
        ELSE
          DV=(DV1*DV2)/(DV1+DV2)
        ENDIF
      ENDIF
C
C.... SAVE PREVIOUS SETTING OF IEDGE BEFORE CALLING JMPLT2
      IEDGP=IEDGE
C
      CALL JMPLT2(U,V,DU,DV,IEDGE)
C
C.... COMPUTE COSINE OF ANGLE BETWEEN TOOL AND SURFACE NORMALS
C
      CALL DOTF(CA,PN,RN)
      DIFCA=1.D0-PSIDE*CA
C
      IF ( (ABS(DU).LT.DUMIN .AND. ABS(DV).LT.DVMIN).OR.
     +      DIFCA.LT.ETA8 ) THEN
C.... CONVERGENCE
        CONTINUE
      ELSE
        IF (NITERA.GE.NITLIM) THEN
C.... NO CONVERGENCE AFTER NITLIM ITERATIONS
C     CARRY OUT THREE MORE ITERATIONS AND INTERROGATE PENETRATION VALUES
          IF (NITERA.LE.(NITLIM+3)) THEN
            IEXT=IEXT+1
C.... SAVE VALUES FOR SUBSEQUENT INTERROGATION
            DO 12 I=1,3
              SP(I,IEXT)=R(I)
              TP(I,IEXT)=P(I)
              TN(I,IEXT)=PN(I)
   12       CONTINUE
            UP(IEXT)=U
            VP(IEXT)=V
            PEN(IEXT)=PENMAX
            JPEN(IEXT)=IPEN
            IEDG(IEXT)=IEDGP
            IF (NITERA.LT.(NITLIM+3)) THEN
C.... TRY AGAIN
              U=U+DU
              V=V+DV
              GOTO 10
            ELSE
              IF (IBUG.EQ.11) THEN
C
C.... DEBUG PRINT
C
                CALL BAD(-1,0,' ',0)
                MSG=' NO CONVERGENCE IN MIXAL - LAST FOUR ITERATIONS'
                CALL CPRINT(MSG)
                DO 13 I=1,4
                  CALL BAD(1,0,'IEXT',I)
                  CALL BAD(1,1,'UP  ',UP(I))
                  CALL BAD(1,1,'VP  ',VP(I))
                  CALL BAD(1,1,'PEN ',PEN(I))
                  CALL BAD(1,0,'JPEN',JPEN(I))
                  CALL BAD(-1,0,'IEDG',IEDG(I))
                  CALL BAD(3,1,'SP  ',SP(1,I))
                  CALL BAD(3,1,'TP  ',TP(1,I))
                  CALL BAD(-3,1,'TN  ',TN(1,I))
   13           CONTINUE
              ENDIF
C.... THREE MORE ITERATIONS COMPLETED - INTERROGATE PENETRATIONS
              IT=1
              PENMAX=PEN(IT)
              DO 14 I=2,4
                IF (PEN(I).GT.PENMAX) THEN
                  PENMAX=PEN(I)
                  IT=I
                ENDIF
   14         CONTINUE
C.... RETURN WORST CASE (I.E. LARGEST PENETRATION)
              DO 16 I=1,3
                R(I)=SP(I,IT)
                P(I)=TP(I,IT)
                PN(I)=TN(I,IT)
   16         CONTINUE
              U=UP(IT)
              V=VP(IT)
              IPEN=JPEN(IT)
              IEDGE=IEDG(IT)
C
              IF (PENMAX.GT.0.D0) THEN
C.... PENETRATION WITHOUT CONVERGENCE
                IFLAG=-1
                MSG='0PENETRATION DETECTED WITHOUT CONVERGENCE'
                CALL CPRINT(MSG)
                CALL CFORM(' PENMAX =',MSG,1,9)
                CALL FCONV(PENMAX,MSG,11,13,6)
                CALL CPRINT(MSG)
              ELSE
C.... NO CONVERGENCE AND NO OBSERVED PENETRATION
                IFLAG=0
              ENDIF
            ENDIF
          ENDIF
        ELSE
C.... TRY AGAIN
          U=U+DU
          V=V+DV
          GOTO 10
        END IF
C
      ENDIF
C
C.... STORE SURFACE POINT, TOOL POINT AND NORMAL AT CONVERGENCE
C     OR FINAL ATTEMPT AT CONVERGENCE
      DO 20 I=1,3
        PPOINT(I)=R(I)
        TPOINT(I)=P(I)
        PNORM(I)=PN(I)
20    CONTINUE
C... STORE U,V OF SURFACE POINT
      UPEN=U
      VPEN=V
C
      END
