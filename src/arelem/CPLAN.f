**** SOURCE FILE : M0000878.V07   ***
*
C
C.....FORTRAN SUBROUTINE             CPLAN....              4/1/68   GK
C
      SUBROUTINE CPLAN
      IMPLICIT DOUBLE PRECISION(A-H),DOUBLE PRECISION(O-Z)
C
C
C
      INCLUDE 'TOTAL.INC'
      INCLUDE 'DSHAR4.INC'
      INCLUDE 'FXCOR.INC'
      INCLUDE 'SV.INC'
      INCLUDE 'ZNUMBR.INC'
      INCLUDE 'ISV.INC'
      INCLUDE 'IFXCOR.INC'
      INCLUDE 'ISHR18.INC'
      INCLUDE 'KNUMBR.INC'
      COMMON/ADDCOM/ADDCOM
      DIMENSION ADDCOM(25)
      EQUIVALENCE (ADDCOM( 1),ELMAX ),
     2            (ADDCOM(25),KDYNFL)
C
C
      INCLUDE 'BLANKCOM.INC'
C
C
      DATA ZLIT1 / .05D0/
C
C
      TEMP(20)=RC(IS)
C                  TEST IF CYLINDER IT SURF,PLANE IS SURF
C
      IF(IPL(IS))10,1010,10
 10   IF(IFL4(IS))20,30,20
 20   IT = IPS
      GO TO 50
 30   IT = IDS
 50   GO TO 3000
 1010 CALL CROSS (SN(1,IS),SNK(1,IS),TEMP)
 1020 CALL VNORM (TEMP,TEMP)
 1030 IF(IER) 1040,1050,1040
 10500TEMP1=TEMP(1)*(SP(1,IS)-SPK(1,IS)) +
     1      TEMP(2)*(SP(2,IS)-SPK(2,IS)) +
     2      TEMP(3)*(SP(3,IS)-SPK(3,IS))
 1060 TEM(1)=SPK(1,IS)+TEMP1*TEMP(1)
      TEM(2)=SPK(2,IS)+TEMP1*TEMP(2)
      TEM(3)=SPK(3,IS)+TEMP1*TEMP(3)
 1090 CALL CCURV(IS,SP(1,IS),TEM,TN(1,IS))
 1120 IF(IFL4(IS))1130,1140,1130
 1130 IT = IPS
      ITT = IDS
      GO TO 1150
 1040 RC(IS)=RC1*DSIGN(Z1,RC(IS))
      GO TO 1120
 1140 IT = IDS
      ITT = IPS
 1150 IF(DABS(SP(3,IT)-SPK(3,IT))-Z1EM3) 2,1,1
    2 TEM(1)=TI(1)
      TEM(2)=TI(2)
      TEM(3)=TI(3)
      GO TO 5
    1 CALL CROSS(SN(1,IT),SN(1,ITT),TEM)
      CALL VNORM(TEM,TEM)
      IF(IER)2,3,2
    3 IF(TI(1)*TEM(1)+TI(2)*TEM(2)+TI(3)*TEM(3)) 4,5,5
    4 TEM(1)=-TEM(1)
      TEM(2)=-TEM(2)
      TEM(3)=-TEM(3)
    5 ISIS=IS
      IS=IT
      TEMP(4)=S(IS)
      TEMP(1)=TP(1,IS)
      TEMP(2)=TP(2,IS)
      TEMP(3)=TP(3,IS)
      TP(1,IS)=TP(1,IS)  -ZLIT1*TEM(1)
      TP(2,IS)=TP(2,IS)-ZLIT1*TEM(2)
      TP(3,IS)=TP(3,IS)-ZLIT1*TEM(3)
      CALL DDST
      TEM(1)=TP(1,IS)+S(IS)*TN(1,IS)
      TEM(2)=TP(2,IS)+S(IS)*TN(2,IS)
      TEM(3)=TP(3,IS)+S(IS)*TN(3,IS)
      TP(1,IS)=TEMP(1)
      TP(2,IS)=TEMP(2)
      TP(3,IS)=TEMP(3)
      S(IS)=TEMP(4)
      IS=ISIS
 1200 PLNCS(IS) = TN(1,IT)*TN(1,IS)+TN(2,IT)*TN(2,IS)+TN(3,IT)*TN(3,IS)
 1210 IF(EPS2(IS)-DABS(PLNCS(IS))) 1220,1240,1240
 1220 IF (CPLFL(IS)) 1250,1230,1250
 1230 DPLAN(1,IS) = TN(1,ITT)
      DPLAN(2,IS) = TN(2,ITT)
      DPLAN(3,IS) = TN(3,ITT)
      GO TO 1250
 1240 CALL CROSS(TN(1,IS),TN(1,IT),DPLAN(1,IS))
 1250 IF (IPL(IT)) 1600,1260,1600
C        USE RC1   FOR PROPER UNITS/ IMPLEMENTATION
 1600  IF ( DABS(RC(IS))-RC1 ) 1610,1620,1620
 1610 TEMP(1) = TN(1,IT)
      TEMP(2) = TN(2,IT)
      TEMP(3) = TN(3,IT)
      GO TO 1380
 1620 CPTST(IS)=-Z1
      PLND(IS)=S(IS)
      CPLFL(IS)=-Z1
      PLNV(1,IS)= TN(1,IS)
      PLNV(2,IS)= TN(2,IS)
      PLNV(3,IS)= TN(3,IS)
 9998 JCPR = 0
 9999 RC(IS)=TEMP(20)
      IF(KDYNFL.NE.K0) CALL APT238(K31)
      RETURN
 1260 CALL CCURV(IT,SP(1,IT),TEM,SN(1,IT))
      IF (KDYNFL.NE.K0) CALL APT238(K34)
 1310  IF ( DABS(RC(IT))-RC1 ) 1320,1600,1600
 1320 IF (IPL(IS)) 1340,1330,1340
 1340 CC(1,IS)= CC(1,IT)
      CC(2,IS)= CC(2,IT)
      CC(3,IS)= CC(3,IT)
      TEMP(1) = TN(1,IS)
      TEMP(2) = TN(2,IS)
      TEMP(3) = TN(3,IS)
      GO TO 1380
 1330  IF ( DABS(RC(IS))-RC1 ) 1370,1340,1340
 1370 TEMP(1) = CC(1,IT)-CC(1,IS)
      TEMP(2) = CC(2,IT)-CC(2,IS)
      TEMP(3) = CC(3,IT)-CC(3,IS)
      CALL VNORM(TEMP,TEMP)
      IF(IER)1380,1380,1340
 1380 CALL CROSS(TEMP,DPLAN(1,IS),PLNV(1,IS))
      CALL VNORM (PLNV(1,IS),PLNV(1,IS))
 1390 IF(IER)1400,1410,1400
C
 1400 JCPR = 1
      GO TO 9999
C
C                  FIND EXTREME POINT ON TOOL IN DIRECTION OF TEMP
C
 1410 ISS = IS
      IGS = 1
      IS  = IGS
      ITS = IT
C
C                  IF TAXIS NORM IT SURF, THEN TP = TE
C
      IF(MANTAX-2)1460,1415,1417
 1415 IF(IT-IPS)1460,1418,1460
 1417 IF(IT-IDS)1460,1418,1460
 1418 TP(1,IS)  =TE(1)
      TP(2,IS)=TE(2)
      TP(3,IS)=TE(3)
      GO TO 1470
 1460 CONTINUE
C
      TV=TEMP(1)*TN(1,IT)+TEMP(2)*TN(2,IT)+TEMP(3)*TN(3,IT)
      TEM(1)=DSIGN(Z1,TV)
      SN(1,IS)  =-TEM(1)*TEMP(1)
      SN(2,IS)=-TEM(1)*TEMP(2)
      SN(3,IS)=-TEM(1)*TEMP(3)
C                  USE TLNORM TO ESTABLISH CORRECT TOOL POINT
C
      RC(IS) = RC1
      CC(1,IS)=TP(1,IT)-RC(IS)*SN(1,IS)
      CC(2,IS)=TP(2,IT)-RC(IS)*SN(2,IS)
      CC(3,IS)=TP(3,IT)-RC(IS)*SN(3,IS)
      JTN(IS) =Z0
      CALL U1COMP
C
      ITSEG(IS)=1
      ITLON(IS)=ITLON(ISS)
      IAFL(IS) =-1
      JTLFLG(IS)=JTLFLG(ISS)
      IPL(IS) = Z1
      CALL TLNORM (U1(1,IS))
C
C                  COMPUTE MOVE TO BRING THIS TP ON TO THE CPLAN
C
 1470 CONTINUE
      PLND(ISS) = PLNV(1,ISS)*(CC(1,ISS)-TP(1,IS))
     1           +PLNV(2,ISS)*(CC(2,ISS)-TP(2,IS))
     2           +PLNV(3,ISS)*(CC(3,ISS)-TP(3,IS))
C
C                  RETURN
C
      IS=ISS
      IT=ITS
 1510 CPLFL(IS)=1.0
 1520 CPTST(IS)=CPTST(IS)+CPLFL(IS)
 1530 IF(CPTST(IS))9998,1520,9998
C
C                  SPECIAL ROUTE FOR CYLINDER IT SURF + PLANE IS SURF
C                  COMPUTE CPLAN POISTION FROM CANONICAL FORMS
C
 3000 IF((ISFIDN(IT).GT.K4).OR.(ISFIDN(IT).LT.K3)) GO TO 1010
      IC=ICANON(IT)
      TEMP(7)=CANON(IC+3)
      TEMP(8)=CANON(IC+4)
      TEMP(9)=CANON(IC+5)
      CALL CROSS(TEMP(7),SN(1,IS),PLNV(1,IS))
      CALL VNORM(PLNV(1,IS),PLNV(1,IS))
C
      CC(1,IS)=CANON(IC)
      CC(2,IS)=CANON(IC+1)
      CC(3,IS)=CANON(IC+2)
      PLNCS(IS)=TN(1,IT)*TN(1,IS)+TN(2,IT)*TN(2,IS)+TN(3,IT)*TN(3,IS)
      TEMP(1) = TN(1,IS)
      TEMP(2) = TN(2,IS)
      TEMP(3) = TN(3,IS)
      GO TO 1410
       END
