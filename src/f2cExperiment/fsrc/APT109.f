**** SOURCE FILE : M0004508.W01   ***
*
      SUBROUTINE APT109(A1,II,A2,A3,A4,A5,A6,A7)
      IMPLICIT DOUBLE PRECISION(A-H),DOUBLE PRECISION(O-Z)
C---- THIS ROUTINE HANDLES THE GEOMETRIC CONSTRUCTION RELATED WITH
C---- SCULPTURED SURFACE AND CURVE
C---- ARGUMENTS LIST APT109(A1,II,A2,A3,A4,A5,A6,A7)
C----    AUFRUFPARAMETER:
C----   II    A2    A3    A4     A5     A6    A7
C=====================================================
C----   PUNKT/VEKTOR MITTELS PARAMETER AUF SYNTHETISCHER KURVE
C----             PNT
C----             TANSPL   FLOW              NOUNIT
C----   2, SCURV ,CRSSPL ,PARAM,  T   ,  S  , UNIT
C----             NORMAL
C----             BINORM
C=====================================================
C----   PUNKT/VECTOR ALS SCHNITTPUNKT ZWISCHEN EBENE UND KURVE
C----             PNT
C----             TANSPL        LINE         NOUNIT
C----   3, SCURV ,CRSSPL ,-----,PLANE ,POINT, UNIT
C----             NORMAL
C----             BINORM
C=====================================================
C----   PUNKT/VECTOR MITTELS PARAMETER AUF SKULPTURIERTER FLAECHE
C----             PNT
C----             TANSPL                     NOUNIT
C----   4, SSURF ,CRSSPL ,  U  ,  V   ,  P  , UNIT
C----             NORMAL
C=====================================================
C----   PUNKT/VECTOR IN DER NAEHE EINES PUNKTES AUF S.-FLAECHE
C----             PNT
C----             TANSPL                     NOUNIT
C----   5, SSURF ,CRSSPL ,POINT,------,-----, UNIT
C----             NORMAL
C=====================================================
C----   PUNKT/VECTOR  AM SCHNITTP. ZWISCHEN DER GERADEN DURCH DIE BEIDEN
C----   PUNKTE UND DER S.-FLAECHE,NAECHSTLIEGEND ZUM 1. PUNKT
C----             PNT
C----             TANSPL                     NOUNIT
C----   6, SSURF ,CRSSPL ,POINT,------,POINT, UNIT
C----             NORMAL
C=====================================================
C---- PUNKT/VECTOR  AM SCHNITTP. ZWISCHEN DER GERADEN DURCH PUNKT
C---- ENTLANG VEKTOR UND DER S.-FLAECHE,NAECHSTLIEGEND ZUM PUNKT
C----             PNT
C----             TANSPL                     NOUNIT
C----   7, SSURF ,CRSSPL ,POINT,VECTOR,-----, UNIT
C----             NORMAL
C=====================================================
C---- PUNKT/VECTOR  AM SCHNITTP. ZWISCHEN DER GERADEN DURCH 1. PUNKT
C---- ENTLANG VEKTOR UND DER S.-FLAECHE,NAECHSTLIEGEND ZUM PUNKT,
C---- DER DURCH PROJEKTION DES 2. PUNKTES AUF DIEGERADE ENTSTEHT
C----             PNT
C----             TANSPL                     NOUNIT
C----   8, SSURF ,CRSSPL ,POINT,VECTOR,POINT, UNIT
C----             NORMAL
C=====================================================
C
C  DIE AUFRUF-PARAMETER HABEN SOWEIT SIE SICH NICHT SELBST ERKLAEREN
C  FOLGENDE BEDEUTUNG:
C
C
C    PNT    : IST EQUIVALENT MIT 0.0D0 UND SOLL SIGNALISIEREN,
C              DASS DAS ERGEBNIS EIN PUNKT SEIN SOLL
C    NOUNIT : IST EQUIVALENT MIT 0.0D0 UND BEDEUTET, DASS DAS ERGEBNIS
C              NICHT NORMALISIERT WERDEN SOLL
C    T      : KURVENPARAMETER
C    S      : KURVENSEGMENTNUMMER
C    U,V    : FLAECHENPARAMETER
C    P      : FLAECHEN-BLATT-NUMMER
C    -------: PARAMETER OHNE RELEVANZ
C
C
C
      INCLUDE 'TOTAL.INC'
      INCLUDE 'DEF.INC'
      INCLUDE 'DSHAR3.INC'
      INCLUDE 'ZNUMBR.INC'
      INCLUDE 'LDEF.INC'
      INCLUDE 'IDEF.INC'
      INCLUDE 'ISHR16.INC'
      INCLUDE 'KNUMBR.INC'
C
      DIMENSION A1(*),A2(4),A3(2),A4(2),A5(2),A6(2),A7(2)
      DIMENSION A4I(3),A5I(4),A6I(3)
      DIMENSION EA(3),FA(4),FB(4),ROOT(2,30),TPP(3)
      DIMENSION SSDUM(3),SPV(32),IFLAG(4),PATCH(64),ITOP(6,4)
       DIMENSION TP(3),TN(3),SP(32),SN(3),SLX(3),JJJ(2),I2(2)
      CHARACTER*8 TANSPL,CRSSPL,BINORM,FLOW,XNORM,UNIT,PARAM,TEST
      LOGICAL CKDEF
C
      INCLUDE 'BLANKCOM.INC'
C
      EQUIVALENCE (SMAL1,Z1EM3), (AA,JJJ(1))
      INTEGER IXNORM(2)
      EQUIVALENCE (IXNORM(1),XNORM1)
C
C    SPEICHERINDEX (KK) FUER ENTSPRECHENDEN ERGEBNISPLATZ
C IN SPV BEI SCURV UND SSURF
      INTEGER ISPVC(5),ISPVS(4)
      COMMON/IBUGG/IBUG,IPCOLC,IPCOMC
C  UEBERGABECOMMON FUER --PARMF--
      COMMON/PARMFC/UA,VA,PNUM,UT,US,FNAM
      DATA TANSPL,CRSSPL,BINORM/'TANSPL  ','CRSSPL  ','BINORM  '/
      DATA FLOW,XNORM/'FLOW    ','NORMAL  '/
      DATA IXNORM/2,0/
      DATA UNIT,PARAM/'UNIT    ','PARAM   '/
      DATA ISPVC/1,5,17,29,0/,ISPVS/1,5,9,25/
C
      FNAM=0.D0
      GOTO (400,400,401,400,401,401,401,401),II
      GOTO 400
  401 CALL UNPACK(A2(1),MOD1,ISIZE,ISUB)
      FNAM=A2(ISIZE+1)
      IF(ISUB.GE.1)FNAM=A2(ISUB*ISIZE+ISUB)
  400 CONTINUE
C
C   KONTROLL OB GEOMETRIEDEFINITIONEN IN ORDNUNG
C
      GOTO (5158,510,510,510,501,501,501,501),II
      GOTO 5158
  501 IF(CKDEF(A4))GOTO 5157
      CALL TRANSF(A4I,A4,2,3,0)
  510 GOTO (5158,520,511,520,520,520,511,511),II
  511 IF(CKDEF(A5))GOTO 5157
      MO=3
      IF(II.EQ.3)MO=4
      CALL TRANSF(A5I,A5,MO,MO,0)
  520 GOTO (5158,530,521,530,530,521,530,521),II
  521 IF(CKDEF(A6))GOTO 5157
      CALL TRANSF(A6I,A6,2,3,0)
C    KONTROLLE DER SYNTHETISCHEN OBERFLAECHE
  530 IF(CKDEF(A2))GOTO 5157
C
C    ABFRAGE DER ERGEBNISART (PUNKT/TANSPL/CRSSPL/NORMAL/BINORM)
C
      IA=1
      IF(A3(1).EQ.0.0D0 )GOTO 540
      IA=2
      CALL HOLFRM(A3(1),TEST,1,8,NWD)
      IF(TEST.EQ.TANSPL)GOTO 540
      IA=3
      IF(TEST.EQ.CRSSPL)GOTO 540
      IA=4
      IF(A3(1).EQ.XNORM1)GOTO 540
      IF(ABS(A3(1)-2.D0).LE.Z1EM6)GOTO 540
      IF(TEST.EQ.XNORM )GOTO 540
      IA=5
      IF(TEST.EQ.BINORM)GOTO 540
      GOTO 5158
C
C   ABFRAGE AUF PARAM ODER FLOW
C
  540 IP=0
      IF(II.NE.2)GOTO 550
      IP=1
      CALL HOLFRM(A4(1),TEST,1,8,NWD)
      IF(TEST.EQ.PARAM)GOTO 550
      IP=2
      IF(TEST.EQ.FLOW )GOTO 550
      GOTO 5158
C
C    ABFRAGE AUF UNIT
C
  550 IU=0
      IF(A7(1).EQ.0.0D0 )GOTO 560
      IU=1
      CALL HOLFRM(A7(1),TEST,1,8,NWD)
      IF(TEST.EQ.UNIT  )GOTO 560
      GOTO 5158
C
C     FEHLERAUSGAENGE
C
C     FEHLER 5153 : BLATTNUMMER DER SSURF IST FALSCH
 5153 IERROR=5153
 5150 UNFLAG=.TRUE.
      CALL DEFEXT(A1)
      RETURN
C     FEHLER 5154 : PARAMETERANGABE IST NICHT KORREKT
C5154 IERROR=5154
C     GOTO 5150
C     FEHLER 5155 : VEKTORLAENGE IST FUER DIE NORMALISIERUNG ZU KLEIN
 5155 IERROR=5155
      GOTO 5150
C     FEHLER 5156 : SCHNITTPUNKT KANN NICHT DEFINIERT WERDEN
 5156 IERROR=5156
      GOTO 5150
C     FEHLER 5157 : EINGEGEBENE GEOMETRIE IST NICHT VORHER DEFINIERT
 5157 IERROR=5157
      GOTO 5150
C     FEHLER 5158 : DEFINITIONSFEHLER
 5158 IERROR=5158
      GOTO 5150
C     FEHLER 5159 : SPEZIFIZIERTER VEKTOR ODER PUNKT EXISTIERT NICHT
 5159 IERROR=5159
      GOTO 5150
C
  560 CONTINUE
C    SCURV ODER SSURF  WIRD GEHOLT
C
      SSDUM(1)=A2(1)
      SSDUM(2)=A2(2)
      SSDUM(3)=A2(3)
      IMODE=3
      CALL APT094(IMODE,SSDUM,J11)
      IF(CKDEF(SSDUM(1))) GOTO 5157
      J11=J11-41
C
C  PARAMETER-UEBERTRAGUNG IN ABHAENGIGKEIT VON DER AUFGABE
C
      GOTO( 5158,572,573,574,575,576,577,578),II
C
C PUNKT/VECTOR MITTELS PARAMETER AUS SCURV
C
  572 U=A5(1)
      I=A6(1)
C   UMSPEICHERINDEX FUER SPV
  581 KK=ISPVC(IA)
C   STEUERUNG FUER ROUTINE CURFLO
      MM=1
      IF(IA.LT.3)GOTO 580
      MM=2
      GOTO 580
C
C  PUNKT/VEKTOR AM DURCHSTOSSPUNKT SCURV/EBENE
C
  573 DO 301 MN=1,3
      EA(MN)=A6I(MN)
  301 FA(MN)=A5I(MN)
      FA(4)=-A5I(4)
      GOTO 581
C
C  PUNKT/VECTOR MITTELS PARAMETER AUS SSURF
C
  574 PA01=A4(1)
      PB01=A5(1)
      PC01=A6(1)
      MPATCH=CAN(J11+4)
      MESH=CAN(J11+5)
      IF(DABS(PC01).GT.SMAL1) GOTO 2250
      NSPL=CAN(J11+9)-1.
      NPNT=CAN(J11+10)-1.
      IPA01=PA01
      IPB01=PB01
      IF(IPA01.LT.NPNT) GOTO 2110
      IPA01=NPNT-1
 2130 PU01=PA01-IPA01
 2140 IF(IPB01.LT.NSPL) GOTO 2120
      IPB01=NSPL-1
 2150 PV01=PB01-IPB01
 2160 NPATCH=IPB01*NPNT+IPA01+1
      GOTO 2310
 2110 IF(IPA01.GE.0) GOTO 2130
      IPA01=0
      PU01=PA01
      GOTO 2140
 2120 IF(IPB01.GE.0) GOTO 2150
      IPB01=0
      PV01=PB01
      GOTO 2160
 2250 IF(PC01.LT.0.D0) GOTO 5153
      IPC01=PC01
      IF((IPC01.GT.MPATCH).OR.(IPC01.LE.0)) GOTO 5153
      PU01=PA01
      PV01=PB01
      NPATCH=IPC01
 2310 CONTINUE
      CALL LODPCH(CAN(J11+1),PATCH,IFLAG,ITOP,NPATCH,1)
C
      KK=ISPVS(IA)
C       STEUERUNG FUER ROUTINE CNSURF
      MM=0
      IF(IA.EQ.1)GOTO 580
      MM=1
      GOTO 580
C
C    PUNKT/VEKTOR IN DER NAEHE EINES PUNKTES AUF DER SSURF
C
  575 TP(1)=A4I(1)
      TP(2)=A4I(2)
      TP(3)=A4I(3)
      TN(1)=0.0
      TN(2)=0.0
      TN(3)=1.0
      MODE=0
  585 KK=ISPVS(IA)
      GOTO 580
C
C   PUNKT/VEKTOR AUF GERADEN (DURCH 2 PUNKTE) UND SSURF
C
  576 DO  584 MN=1,3
      TP(MN)=A4I(MN)
      TN(MN)=A6I(MN)-A4I(MN)
  584 CONTINUE
      MODE=-1
      GOTO 585
C
C    PUNKT/VECTOR AUF GERADEN (DURCH PUNKT,ENTLANG VEKTOR) UND SSURF
C
  577 DO  583 MN=1,3
      TP(MN)=A4I(MN)
      TN(MN)=A5I(MN)
  583 CONTINUE
      MODE=-1
      GOTO 585
C
C    PUNKT/VEKTOR AUF GERADEN (PUNKT,VECTOR),NAHE EINEM PUNKT,AUF SSURF
C
  578 DO  582 MN=1,3
      TN(MN)=A5I(MN)
      TP(MN)=A6I(MN)
      TPP(MN)=A4I(MN)
      TP(MN)=TP(MN)-TPP(MN)
  582 CONTINUE
      DD=DSQRT(TN(1)*TN(1)+TN(2)*TN(2)+TN(3)*TN(3))
      IF(DD.LT.SMAL1)GOTO 5155
      DDD=(TP(1)*TN(1)+TP(2)*TN(2)+TN(3)*TP(3))
      DDD=DDD/DD
      TP(1)=DDD*(TN(1)/DD)+TPP(1)
      TP(2)=DDD*(TN(2)/DD)+TPP(2)
      TP(3)=DDD*(TN(3)/DD)+TPP(3)
      MODE=-1
      GOTO 585
C
C===================================================================
C    DURCHFUEHRUNG DER AUFGABEN
C===================================================================
C
  580 GOTO(5158,2000,3000,4000,6000,6000,6000,6000),II
C
C  PUNKT/VEKTOR MITTELS PARAMETER AUS SCURV
 2000 CONTINUE
C  AUF ALLE FAELLE AUSSPEICHERN DER 'ANZAHL FLOW-SEGMENTE'
      NMAX=CAN(J11+8)
      IF(IP.EQ.2)GOTO 2100
C  BEI PARAM-INTERPOLATION WIRD CAN(J11+8) VORUEBERGEHEND 0.0D0
      CAN(J11+8)=0.0D0
 2100 CALL CURFLO(U,CAN(J11+1),SPV,MM,I)
C  NMAX WIRD WIEDER EINGESETZT
      CAN(J11+8)=NMAX
C   VERZWEIGUN NACH ERGEBNISART
      GOTO(2200,2200,2300,2300,2400),IA
 2200 A1(1)=SPV(KK)
      A1(2)=SPV(KK+1)
      A1(3)=SPV(KK+2)
      IF(IA.EQ.1)GOTO 9100
      GOTO 9200
C   GUELTIGKEITS ABFRAGE BEI CRSSPL U. NORMAL
 2300 IF(SPV(20).NE.1.0D0)GOTO 5159
      GOTO 2200
C   BERECHNUNG DER BINORMALEN
 2400 CALL CROSS(SPV(5),SPV(9),A1(1))
      GOTO 9200
C
C   PUNKT/VECTOR AUF EBENE UND SCURV  (DURCHSTOSSGEOMETRIE)
C
 3000 MBLK=CAN(J11+4)
      KK1=0
      NBLK=1
C   BERECHNUNG BEI DER ANFANGSTANGENTE (AUSSERHALB LIEGENDER PUNKT)
      CALL CNCURV(0.D0,CAN(J11+25),SPV,1)
      AB=FA(1)*SPV(1)+FA(2)*SPV(2)+FA(3)*SPV(3)+FA(4)
      AC=FA(1)*SPV(5)+FA(2)*SPV(6)+FA(3)*SPV(7)
      IF(DABS(AC).LT.1.D-6) GOTO 370
      XYZ=-AB/AC
      IF(XYZ.GT.1.D-5) GOTO 370
C   PUNKT GEFUNDEN
      KK1=KK1+1
      ROOT(1,KK1)=J11+25
      ROOT(2,KK1)=XYZ
  370 NBLK01=NBLK*24+J11+1
      DO 320 NSPL=1,4
  320 SPV(NSPL)=0.
      DO 330 NPNT=1,4
      MN=(NPNT-1)*4
      DO 331 NSPL=1,4
  331 FB(NSPL)=CAN(NBLK01+MN+NSPL-1)
      SPV(1)=SPV(1)+FA(NPNT)*(2*FB(1)-2*FB(2)+FB(3)+FB(4))
      SPV(2)=SPV(2)+FA(NPNT)*(-3*FB(1)+3*FB(2)-2*FB(3)-FB(4))
      SPV(3)=SPV(3)+FA(NPNT)*FB(3)
  330 SPV(4)=SPV(4)+FA(NPNT)*FB(1)
      CALL GCUBIC(SPV(1),SPV(2),SPV(3),SPV(4),FB,MN)
      IF(MN.EQ.0) GOTO 380
      DO 340 NSPL=1,MN
      XYZ=FB(NSPL)
      IF((XYZ.GE.-1.D-5).AND.(XYZ.LT.1.00001D0)) THEN
        KK1=KK1+1
        ROOT(1,KK1)=NBLK01
        ROOT(2,KK1)=FB(NSPL)
      END IF
C
C
C
  340 CONTINUE
  380 NBLK=NBLK+1
      IF(NBLK.GT.MBLK) GOTO 360
      GOTO 370
C   BERECHNUNG BEI DER ENDTANGENTE (AUSSERHALB LIEGENDER PUNKT)
  360 CALL CNCURV(1.D0,CAN(NBLK01),SPV,1)
      AB=FA(1)*SPV(1)+FA(2)*SPV(2)+FA(3)*SPV(3)+FA(4)
      AC=FA(1)*SPV(5)+FA(2)*SPV(6)+FA(3)*SPV(7)
      IF(DABS(AC).LT.1.D-6) GOTO 361
      XYZ=-AB/AC+1.D0
      IF(XYZ.LT..99999D0) GOTO 361
C   PUNKT GEFUNDEN
      KK1=KK1+1
      ROOT(1,KK1)=NBLK01
      ROOT(2,KK1)=XYZ
  361 IF(KK1.EQ.0) GOTO 5156
      MN=1
  335 NBLK01=ROOT(1,MN)
      CALL CNCURV(ROOT(2,MN),CAN(NBLK01),SPV,1)
      DDIST1=(SPV(1)-EA(1))**2+(SPV(2)-EA(2))**2+(SPV(3)-EA(3))**2
      IF(MN.NE.1) GOTO 315
  325 A1(1)=SPV(1)
      A1(2)=SPV(2)
      A1(3)=SPV(3)
      UT=ROOT(2,MN)
      IS=(ROOT(1,MN)-J11)/24.D0
      US=IS
      DDIST=DDIST1
  345 MN=MN+1
      IF(MN.GT.KK1) GOTO 3100
      GOTO 335
  315 IF(DDIST.GT.DDIST1) GOTO 325
      GOTO 345
C  DURCHSTOSSPUNKT GEFUNDEN
 3100 IF(IA.EQ.1)GOTO 9100
C VEKTOR WIRD GEWUENSCHT:INTERPOLATION DES VEKTORS WIRD VORBEREITET
      IP=1
      U=UT
      NBLK01=US*24.D0+1.D0+J11
      I=US
      GOTO 2000
C
C  PUNKT/VEKTOR MITTELS PARAMETER AUS SSURF
C
 4000 CALL CNSURF(PU01,PV01,PATCH,SPV,IFLAG,MM)
      GOTO 2200
C
C   PUNKT/VEKTOR AM ANNAEHERUNGS- O. DURCHSTOSS-PUNKT AUF SSURF
C
 6000 DD=DSQRT(TN(1)*TN(1)+TN(2)*TN(2)+TN(3)*TN(3))
      IF(DD.LT.SMAL1)GOTO 5155
      TN(1)=TN(1)/DD
      TN(2)=TN(2)/DD
      TN(3)=TN(3)/DD
      IFLG=0
 5489 IDEBUG=IBUG
      CALL LODINT(CAN(J11+1),PATCH,UST,VST,TP,TN,IFLAG,
     1   ITOP,IPNUM,MODE)
      IF(IDEBUG.LE.0) GO TO 5487
      CALL BAD(1,0,'A109',IPNUM)
      CALL BAD(1,1,'UST ',UST)
      CALL BAD(-1,1,'VST ',VST)
 5487 CALL SQRCUT(Z5EM1,Z5EM1,UST,VST,UU,VV,ICKBN)
      UST=Z5EM1+0.9999D0*(UU-Z5EM1)
      VST=Z5EM1+0.9999D0*(VV-Z5EM1)
C...CALL PCHPRC WITH LAST PARAMETER .TRUE. FOR GEOMETRIC CONSTRUCTION
      CALL PCHPRC(CAN(J11+1),PATCH,UST,VST,TP,TN,UA,VA,
     1  SPV,SN,SLX,IFLAG,ITOP,IPNUM,MODE,IDEBUG,IRR,.TRUE.)
      PNUM=IPNUM
      IF(SPV(KK+3).EQ.0.0D0)GOTO 5159
      IF(IFLG.NE.0) GO TO 5494
      IFLG=1
      DO 5490 MN=1,3
 5490 TPP(MN)=SPV(MN)-TP(MN)
      CALL DOTV(DDD,TPP,TPP)
      DDD=DDD-.1D0
      CALL DOTV(DD,TPP,TN)
      IF(DD.LT.0.0) GO TO 5492
C---      POINT IS SAME DIRECTION AS VECTOR
      DO 5491 MN=1,3
 5491 TP(MN)=TP(MN)+DDD*TN(MN)
      GO TO 5489
 5492 DO 5493 MN=1,3
 5493 TP(MN)=TP(MN)-DDD*TN(MN)
      GO TO 5489
 5494 CONTINUE
      GOTO 2200
C
C=======================================================================
C
C    ABGESANG
 9100 CALL TRANSF(P,A1,K2,K3,KM1)
      CALL DEFEXT(A1)
      RETURN
 9200 IF(IU.EQ.0)GOTO 9250
      DISTAN=DSQRT(A1(1)*A1(1)+A1(2)*A1(2)+A1(3)*A1(3))
      IF(DISTAN.LT.SMAL1) GO TO 5155
      A1(1)=A1(1)/DISTAN
      A1(2)=A1(2)/DISTAN
      A1(3)=A1(3)/DISTAN
C    FALLS NOTWENDIG TRANSFORMIEREN UND ZURUECK
 9250 CALL APT078(A1,KM1)
      CALL DEFEXT(A1)
      RETURN
      END
