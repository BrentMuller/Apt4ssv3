*
      SUBROUTINE EVDAFS(U,V,GEO,RESULT,MODE)
C THIS SUBROUTINE EVALUATES POINT COORDINATES AND DERIVATIVES ON
C A PATCH OF A VDAFS DEFINED SURFACE. SUBROUTINE BIPROD IS CALLED
C FOR BASIC BILINEAR MATRIX PRODUCT EVALUATION.
C SUBROUTINE CVDAFS ORGANISES ENTIRE COMPUTATION EVDAFS CHECKS INPUT DAT
      DOUBLE PRECISION U,V,RESULT(4,8),GEO(*),AX(625),AY(625),AZ(625)
      DOUBLE PRECISION CU(25),CV(25)
      INTEGER MODE,MU,MV
      MU=INT(GEO(1))
      MV=INT(GEO(2))
      N=MU*MV
      IF(MU.GT.25.OR.MV.GT.25) THEN
         PRINT*,' DEGREE U OR DEGREE V TOO LARGE FOR ARRAY DIMENSIONS'
         RETURN
      ENDIF
      CALL CVDAFS(U,V,GEO,RESULT,MODE,MU,MV,N,AX,AY,AZ,CU,CV)
      RETURN
      END
                                                                        00001900
      SUBROUTINE CVDAFS(U,V,GEO,RESULT,MODE,MU,MV,N,AX,AY,AZ,CU,CV)
C THIS SUBROUTINE PERFORMS ALL BASIC EVALUATION COMPUTATIONS ON VDA SURF
      DOUBLE PRECISION U,V,X,Y,Z,RES(3),AX(N),AY(N),AZ(N),CU(MU)
      DOUBLE PRECISION CV(MV),GEO(*),RESULT(4,8)
      INTEGER MU,MV,N,I,J
C MU=DEGREE+1 IN U, MV=DEGREE+1 IN V FOR THIS PATCH, COEFF MAT IS MU*MV.
C     N=MU*MV
C SET UP COEFFICIENT MATRICES.
      DO 10 I=1,N
      AX(I)=GEO(I+2)
      AY(I)=GEO(I+2+N)
 10   AZ(I)=GEO(I+2+2*N)
C INITIALISE RESULT ARRAY USED TO RETURN POINT ADD DERIVATIVE DATA.
      DO 15 I=1,4
      DO 15 J=1,8
  15  RESULT(I,J)=0.0
      DO 20 I=1,MU
 20   CU(I)=1.0
      DO 30 I=1,MV
 30   CV(I)=1.0
C EVALUATE POINT COORDINATES
      CALL BIPROD(AX,MU,MV,CU,CV,U,V,X)
      CALL BIPROD(AY,MU,MV,CU,CV,U,V,Y)
      CALL BIPROD(AZ,MU,MV,CU,CV,U,V,Z)
      RESULT(1,1)=X
      RESULT(2,1)=Y
      RESULT(3,1)=Z
      RESULT(4,1)=1.0
      IF(MODE.EQ.0) RETURN
C MODE=0 INDICATES THAT ONLY POINT COORDINATES ARE REQUIRED.
C EVALUATE FIRST DERIVATIVES, STORE IN COLS 2 AND 3 OF RESULT.
      DO 40 I=2,MU
 40   CU(I)=I-1.0
      CU(1)=0.0
      CALL BIPROD(AX,MU,MV,CU,CV,U,V,RES(1))
      CALL BIPROD(AY,MU,MV,CU,CV,U,V,RES(2))
      CALL BIPROD(AZ,MU,MV,CU,CV,U,V,RES(3))
      DO 50 I=1,3
 50   RESULT(I,2)=RES(I)
      DO 60 I=1,MU
 60   CU(I)=1.0
      DO 70 I=2,MV
 70   CV(I)=I-1.0
      CV(1)=0.0
      CALL BIPROD(AX,MU,MV,CU,CV,U,V,RES(1))
      CALL BIPROD(AY,MU,MV,CU,CV,U,V,RES(2))
      CALL BIPROD(AZ,MU,MV,CU,CV,U,V,RES(3))
      DO 80 I=1,3
 80   RESULT(I,3)=RES(I)
C EVALUATE MIXED DERIVATIVE (TWIST VECTOR), COL 5 OF RESULT.
      DO 90 I=2,MU
 90   CU(I)=I-1.0
      CU(1)=0.0
      CALL BIPROD(AX,MU,MV,CU,CV,U,V,RES(1))
      CALL BIPROD(AY,MU,MV,CU,CV,U,V,RES(2))
      CALL BIPROD(AZ,MU,MV,CU,CV,U,V,RES(3))
      DO 95 I=1,3
 95   RESULT(I,5)=RES(I)
      IF(MU.LE.2) GO TO 135
C 2ND DERIVATIVE ZERO IF U DEGREE=1
C EVALUATE 2ND DERIVATIVES, STORE IN COLS 4,6 OF RESULT.
      DO 110 I=3,MU
 110  CU(I)=CU(I)*(I-2.0)
      CU(2)=0.0
      DO 120 I=1,MV
 120  CV(I)=1.0
      CALL BIPROD(AX,MU,MV,CU,CV,U,V,RES(1))
      CALL BIPROD(AY,MU,MV,CU,CV,U,V,RES(2))
      CALL BIPROD(AZ,MU,MV,CU,CV,U,V,RES(3))
      DO 130 I=1,3
 130  RESULT(I,4)=RES(I)
 135  CONTINUE
      IF(MV.LE.2) GO TO 165
      DO 140 I=1,MU
 140  CU(I)=1.0
      DO 150 I=3,MV
 150  CV(I)=(I-1.0)*(I-2.0)
      CV(2)=0.0
      CV(1)=0.0
      CALL BIPROD(AX,MU,MV,CU,CV,U,V,RES(1))
      CALL BIPROD(AY,MU,MV,CU,CV,U,V,RES(2))
      CALL BIPROD(AZ,MU,MV,CU,CV,U,V,RES(3))
      DO 160 I=1,3
 160  RESULT(I,6)=RES(I)
 165  CONTINUE
C COMPUTE NORMAL AND UNIT NORMAL, STORE IN COLS 7,8 OF RESULT.
      RESULT(1,7)=RESULT(2,2)*RESULT(3,3)-RESULT(3,2)*RESULT(2,3)
      RESULT(2,7)=RESULT(3,2)*RESULT(1,3)-RESULT(1,2)*RESULT(3,3)
      RESULT(3,7)=RESULT(1,2)*RESULT(2,3)-RESULT(2,2)*RESULT(1,3)
      X=0.0
      DO 170 I=1,3
 170  X=X+RESULT(I,7)*RESULT(I,7)
      X=DSQRT(X)
      IF(X.LT.1.0E-8) RETURN
C NORMAL VECTOR IS NOT WELL DEFINED IF X(VECTOR LENGTH) SMALL.
      DO 180 I=1,3
 180  RESULT(I,8)=RESULT(I,7)/X
      RESULT(4,8)=1.0
C RESULT(4,8)=1 INDICATES A WELL DEFINED UNIT NORMAL IN COL 8.
      RETURN
      END
                                                                        00012100
                                                                        00012200
      SUBROUTINE BIPROD(A,MU,MV,CU,CV,U,V,RES)
C SUBROUTINE TO EVALUATE BILINEAR PRODUCT (PU)'A(PV), WHERE PU, PV ARE
C POWER SERIES WITH COEFFICIENTS CU,CV; LEADIONG 0.0 COEFFICIENTS INDICA
C DERIVATIVE TERMS OF LOWER DEGREE. FINAL (SCALAR) PRODUCT IS RETURNED A
      DOUBLE PRECISION A(MU,MV),CU(MU),CV(MV),U,V,RES,SUM
      INTEGER I,J,MU,MV
      RES=0.0
      DO 20 I=MU,1,-1
      IF(CU(I).LE.0.0) GO TO 30
      SUM=0.0
      DO 10 J=MV,1,-1
      IF(CV(J).LE.0.0) GO TO 15
  10  SUM=SUM*V+CV(J)*A(I,J)
  15  CONTINUE
  20  RES=RES*U+SUM*CU(I)
  30  CONTINUE
C RES NOW CONTAINS THE EVALUATED PRODUCT (PU)'A(PV) AT PARAMETRIC POINT
C THIS WILL CORRESPOND TO A POINT COORDINATE OR A DERIVATIVE VECTOR COMP
      RETURN
      END
