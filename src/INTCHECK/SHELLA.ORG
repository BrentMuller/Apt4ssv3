*
      SUBROUTINE SHELLA(P,PHULL,NP,N3,C,R)
C
C     CALCULATES CENTER C AND RADIUS R OF THE SMALLEST SPHERE WHICH
C     ENCLOSES THE FOUR POINTS P (THE CORNER POINTS OF PATCH).
C     THREE CASES, TESTED IN ORDER:-
C     1. ONE PAIR OF POINTS DEFINE DIAMETER OF SPHERE ENCLOSING ALL
C        FOUR CORNER POINTS. CHOOSE PAIR OF POINTS WITH GREATEST
C        SEPARATION, CHECK THAT OTHER TWO POINTS ARE INSIDE THIS SPHERE
C     2. THREE POINTS DEFINE EQUATOR OF SPHERE ENCLOSING ALL FOUR
C        POINTS. TRY ALL FOUR COMBINATIONS OF THREE POINTS, CHOOSE
C        SMALLEST SPHERE ENCLOSING FOUR POINTS
C     3. MINIMUM SPHERE DEFINED BY ALL FOUR POINTS
C
C     CHECKS THAT SPHERE FOUND ENCLOSES POLYGONAL CONVEX HALL PHULL
C     ADJUSTS RADIUS OF SPHERE BY UP TO 10% TO INCLUDE PHULL
C     IF NO SPHERE FOUND, THEN RETURN WITH R=0
C
C     ON ENTRY, NP, N3 ARE DIMENSIONS OF PHULL
C
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
C
      DIMENSION P(4,3),C(3)
      DIMENSION PHULL(NP,N3)
C
C.... COEFF. MATRIX AND WORKSPACE FOR CASE 3
      DIMENSION H(3,3),WA(3,3)
C.... CENTRE OF TRIAL SPHERE
      DIMENSION CC(3)
      DIMENSION V1(3),V2(3)
      DIMENSION V3(3),V4(3)
      DIMENSION V5(3),VN(3)
C
C.... TEMP FOR TEST ONLY
      DIMENSION X1(3),X2(3)
C
C.... TOLERANCE
      TOL=1D-3
      HALF=1.D0
      HALF=HALF/2.D0
C
C     CASE 1.      TWO POINTS AS DIAMETER
      NCASE=1
C.... INITIALISE RADIUS SQUARED
      R2=0.D0
      DO 10 J=1,3
        DO 15 K=J+1,4
          RT2=0.D0
          DO 20 I=1,3
            A1=P(J,I)
            A2=P(K,I)
C.... CENTRE OF TRIAL SPHERE
            CC(I)=HALF*(A1+A2)
            A1=HALF*(A1-A2)
            RT2=RT2+A1*A1
20        CONTINUE
C
C     RT2 IS SQUARE OF RADIUS OF TRIAL SPHERE
C.... TEST TRIAL SPHERE
          IF (R2.EQ.0.D0 .OR. RT2.LE.R2) THEN
            DO 40 L=1,4
              IF (L.EQ.J .OR. L.EQ.K) GOTO 40
              A=0.D0
              DO 50 I=1,3
                A1=ABS(P(L,I)-CC(I))-TOL
                A=A+A1*A1
50            CONTINUE
C.... POINT OUTSIDE - REJECT
              IF (A.GT.RT2) GOTO 10
40          CONTINUE
C           SPHERE BEST SO FAR: STORE
            R2=RT2
            DO 60 I=1,3
              C(I)=CC(I)
60          CONTINUE
          END IF
15      CONTINUE
10    CONTINUE
C.... ENCLOSING SPHERE FOUND - EXIT
      IF (R2.GT.0.D0) GOTO 300
C
C     CASE 2.      THREE POINTS ON DIAMETRAL PLANE
C
      NCASE=2
      DO 180 J=1,2
        DO 170 K=J+1,3
C.... FOR POINTS J, K, AND L
          DO 160 L=K+1,4
C.... CALC. CIRCUMCIRCLE
            DO 110 I=1,3
              V1(I)=P(K,I)-P(J,I)
              V2(I)=P(L,I)-P(J,I)
              V5(I)=V2(I)-V1(I)
110         CONTINUE
C.... VN IS NORMAL TO PLANE OF THREE POINTS
            CALL CROSS(V1,V2,VN)
            CALL CROSS(V1,VN,V3)
            CALL CROSS(VN,V2,V4)
C
            CALL DEGSOL(V5,V3,V4,A,B,I)
C
            RT2=0.D0
            DO 120 I=1,3
              A1=HALF*(V1(I)+A*V3(I))
C.... CC IS CENTRE OF TRIAL SPHERE
              CC(I)=P(J,I)+A1
C.... RT2 IS SQUARE OF RADIUS OF TRIAL SPHERE
              RT2=RT2+A1*A1
120         CONTINUE
C
C.... TEST TRIAL SPHERE
            IF (R2.EQ.0.D0 .OR. RT2.LE.R2) THEN
              DO 130 KK=1,4
                A=0.D0
                DO 140 I=1,3
                  A1=ABS(P(KK,I)-CC(I))-TOL
                  A=A+A1*A1
140             CONTINUE
C.... POINT OUTSIDE - REJECT
                IF (A.GT.RT2) GOTO 160
130           CONTINUE
C           SPHERE BEST SO FAR: STORE
              R2=RT2
              DO 150 I=1,3
                C(I)=CC(I)
150           CONTINUE
            END IF
160       CONTINUE
170     CONTINUE
180   CONTINUE
C.... ENCLOSING SPHERE FOUND - EXIT
      IF (R2.GT.0.D0) GOTO 300
C
C     CASE 3.      FOUR POINT SPHERE
      NCASE=3
C.... CALC. COEFFS H(K,I), V1(I)
      A=0.D0
      DO 200 K=1,3
        A1=P(4,K)
        A=A+A1*A1
200   CONTINUE
      B=0.D0
      DO 210 K=1,3
        B=A
        DO 220 J=1,3
          A1=P(K,J)
          B=B-A1*A1
          H(K,J)=P(4,J)-P(K,J)
220     CONTINUE
        V1(K)=HALF*B
210   CONTINUE
C
      N3=3
      NN3=3
      NNN3=3
      K=0
C
C     SOLVE 3 X 3 EQNS. FOR CENTRE C
C
      CALL SOLVE3(H,V1,C,K)
C
C.... NO SOLUTION
      IF (K.EQ.1) GOTO 300
      R2=0.D0
C.... NOW CALC. RADIUS
      DO 230 K=1,3
        A1=P(1,K)-C(K)
C.... R2 IS RADIUS SQUARED
        R2=R2+A1*A1
230   CONTINUE
C
C.... R IS RADIUS
300   R=SQRT(R2)
C     CHECK AGAINST CONVEX POLYGON
C
      AMAX=0.D0
      DO 310 K=1,NP
        A=0
        DO 320 I=1,3
          A1=PHULL(K,I)-C(I)
          A=A+A1*A1
320     CONTINUE
        IF (A.GT.R2 .AND. A.GT.AMAX) AMAX=A
310   CONTINUE
C.... ACCEPT RADIUS
      IF (AMAX.EQ.0.D0) GOTO 330
      A1=SQRT(AMAX)
C     A1 IS MAXIMUM DISTANCE OF HULL POINT FROM CENTRE
C     IF A1 SUCH THAT R < A1 < 1.1*R, THEN USE A1 AS RADIUS
      IF (A1.GT.R .AND. A1.LE.(1.1D0*R)) THEN
            R=A1
C.... NO SPHERE FOUND
      ELSE
            R=0.D0
      END IF
330   CONTINUE
C
      END
